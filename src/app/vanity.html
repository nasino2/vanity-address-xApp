<div id="topbar">
  <mat-toolbar color="secondary" fxLayout="row">
    <div fxLayoutAlign="start start" style="width: 50%;">
      <button class="topbar-button-left btn" (click)="openSearchClick()" [ngClass]="{'active' : openSearch}"
        matTooltip="Buy Address">
        <i class="material-icons topbar-menu-icon">search</i>
        <label>&nbsp;Buy Address</label>
      </button>
    </div>
    <div fxLayoutAlign="end end" style="width: 50%;">
      <button class="topbar-button-right btn" (click)="openPurchaseClick()" matTooltip="Show Purchases"
        [ngClass]="{'active' : !openSearch}">
        <i class="material-icons topbar-menu-icon">list</i>
        <label>&nbsp;Show Purchases</label>
      </button>
    </div>
  </mat-toolbar>
</div>

<mat-card class="mat-card-red" *ngIf="errorLabel">
  <label>Sorry that this error happened! Please copy the following error and send it to @XummSupport on twitter or
    visit https://support.xumm.app . Thank you for your help!</label>
  <label>&nbsp;</label>
  <label class="break-words" (click)="copyError()">{{errorLabel}}</label>
  <button mat-button class="xumm-grey-background" aria-label="Copy Error" (click)="copyError()">
    Copy&nbsp;<mat-icon style="font-size: 16px; width: fit-content; height: fit-content;">content_copy</mat-icon>
  </button>
</mat-card>

<div *ngIf="showHelp">
  <label>Here will be some help shown, as FAQ in an accordion model?</label>
  <button mat-raised-button color="primary" (click)="showHelp = false">Close Help</button>
</div>

<!--label class="break-words" *ngIf="infoLabel" style="color: red">{{infoLabel}}</label><br><br>
  <label class="break-words" *ngIf="infoLabel2" style="color: red">{{infoLabel2}}</label>
  <label class="break-words" *ngIf="infoLabel3" style="color: red">{{infoLabel3}}</label-->

<div *ngIf="openSearch">

  <div
    *ngIf="testMode == null || loadingCheckForPurchaseActivation || loadingData || loadingPurchases || !originalAccountInfo"
    class="loader">
    <div class="spinner-border" role="status"></div>
    <label>Loading</label>
    <!-- <label *ngIf="!loadingData">Loading</label>
      <label *ngIf="loadingData">Searching addresses</label> -->
  </div>

  <div *ngIf="testMode != null && !testMode">
    <mat-card class="mat-card-red">
      You can not choose a XRPL vanity address while being connected to the XRP Ledger {{testMode ? 'TEST' : 'MAIN'}}
      net.
      Please connect your XUMM app to the XRP Ledger {{testMode ? 'MAIN' : 'TEST'}} net and open the xApp again.

      <button mat-raised-button class="xumm-grey-background" (click)="close()">Close</button>
    </mat-card>
  </div>


  <div *ngIf="testMode != null && testMode">

    <div *ngIf="!loadingCheckForPurchaseActivation && !selectedVanityAddress">
      <div class="p-3 pb-1">
        <h1 class="sticky mb-0">Find yourself a vanity XRPL address <small>$100 / 210 XRP</small></h1>
      </div>
      <div class="sticky p-3 pt-1 pb-1">
        <form>
          <div class="input-group mb-2 no-wrap-at-all">
            <span class="input-group-text"><i class="bi-search"></i></span>
            <input #inpvanityword class="form-control form-control-lg" minlength="3" maxlength="8" name="vanity word"
              placeholder="Look for your name / brand" [(ngModel)]="vanityWordInput"
              (ngModelChange)="checkVanitySearchChange()">
          </div>
          <button class="btn btn-lg btn-primarylight search" (click)="searchVanityAddress()"
            [disabled]="loadingData || !vanityWordInput || vanityWordInput.trim().length < 3 || !vanityWordValid">Search</button>
          <ul class="notes">
            <li>Always starts with r</li>
            <li>Min. 3 and Max. 8 characters</li>
          </ul>
        </form>
      </div>

      <div *ngIf="searchResult && !selectedVanityAddress">

        <div *ngIf="searchResult.length > 0">
          <div class="listarea p-3 pt-4 pb-2">
            <h3>Adresses found ({{searchResult.length}}) :</h3>
            <ul class="list">
              <li *ngFor="let address of searchResult">
                <code>r<b>{{address.address.substring(1,vanityWordInput.length+1)}}</b>{{address.address.substring(vanityWordInput.length+1)}}</code>
                <div>
                  <button class="btn btn-sm btn-success" (click)="selectVanityAddress(address);">Buy</button>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <div *ngIf="searchResult.length <= 0">
          <div class="alert alert-warning m-3 p-2 text-center">
            <p>No vanity addresses found for your search. Please try a different word!</p>
            <b>Try changing your search word slightly!</b>
          </div>
        </div>

      </div>

    </div>


    <mat-stepper orientation="horizontal" [linear]="isLinear" [@.disabled]="true" #vanityStepper
      *ngIf="selectedVanityAddress">

      <!-- STEP 1 -->
      <mat-step completed="false" editable="false">
        <ng-container *ngIf="!loadingCheckForPurchaseActivation">
          <div class="stepcontainer">
            <ng-container *ngIf="originalAccountInfo">
              <h2>Payment account</h2>
              <ng-container *ngIf="originalAccountInfo && (originalAccountInfo.Account || originalAccountInfo.account)">
                <label>Selected account:</label>
                <code class="address"
                  *ngIf="originalAccountInfo && originalAccountInfo.Account"><b>{{originalAccountInfo.Account}}</b></code>
                <!-- TODO: we need this? -->
                <code class="address"
                  *ngIf="originalAccountInfo && originalAccountInfo.account">{{originalAccountInfo.account}}</code>
              </ng-container>

              <button class="btn btn-lg btn-primarylight changeaccount" (click)="signIn()"
                [disabled]="loadingData">{{originalAccountInfo && (originalAccountInfo.Account ||
                originalAccountInfo.account) ? 'Change account' : 'Sign In' }}</button>
              <hr>
              <div class="alert alert-warning">
                Please choose the account which will be able to sign transactions for your new vanity address. This
                account also needs to be used to activate the vanity address with <b>10 XRP</b> and pay for
                your vanity address (<b>100 USD in XRP</b>)
              </div>

            </ng-container>


            <mat-card
              *ngIf="originalAccountInfo && originalAccountInfo.error && originalAccountInfo.error == 'actNotFound' && !loadingData"
              class="mat-card-red">
              <label>Account not activated on {{testMode ? 'Testnet' : 'Mainnet'}}.</label>
            </mat-card>

            <mat-card *ngIf="originalAccountInfo && balanceTooLow && !loadingData" class="mat-card-red">
              <label>The balance of this account is too low!</label>
              <label>You should have at least {{(amountXrpNeeded/1000000)}} XRP in your account!</label>
            </mat-card>
          </div>

          <footer class="nextback">
            <button class="btn btn-sm btn-primarylight" (click)="moveBack()"
              [disabled]="!originalAccountInfo || loadingData">
              Back
            </button>

            <button class="btn btn-sm btn-success" (click)="moveNext(true)"
              [disabled]="!originalAccountInfo || !originalAccountInfo.Account || loadingData">Next</button>
          </footer>
        </ng-container>
      </mat-step>

      <!-- STEP 2 -->
      <mat-step completed="false" editable="false" *ngIf="!loadingCheckForPurchaseActivation">
        <div class="stepcontainer">
          <h2>Checks</h2>
          <p>Please read the information below carefully and sign the request to accept.</p>
          <!-- <div class="alert alert-warning">Please read the information below carefully and sign the request to accept.
          </div> -->

          <mat-checkbox [(ngModel)]="checkBoxPurchaseAmount" (change)="informationConfirmed = false;"
            [ngClass]="(checkBoxPurchaseAmount ? 'active': '')">You aggree to pay the XRP equivalent of <b>~
              {{getPurchaseAmountUSD()}} USD</b> to buy your vanity address <b>{{selectedVanityAddress &&
              selectedVanityAddress.address}}</b>
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="checkBoxActivation" (change)="informationConfirmed = false;"
            [ngClass]="(checkBoxActivation ? 'active': '')">You need to fund your new vanity address with the <b>10
              XRP</b> reserve fee of the XRP Ledger.</mat-checkbox>
          <mat-checkbox [(ngModel)]="checkBoxVanityAccReadOnly" (change)="informationConfirmed = false;"
            [ngClass]="(checkBoxVanityAccReadOnly ? 'active': '')">Vanity account <b>{{selectedVanityAddress &&
              selectedVanityAddress.address}}</b> needs to be imported as "Read only" in the XUMM app!
          </mat-checkbox>

          <button class="btn btn-lg btn-secondary signbutton" (click)="signToConfirm()"
            [disabled]="loadingData || !checkBoxPurchaseAmount || !checkBoxActivation || !checkBoxVanityAccReadOnly || informationConfirmed">
            Sign to confirm</button>

        </div>
        <footer class="nextback">
          <button class="btn btn-sm btn-primarylight" (click)="moveBack();" [disabled]="loadingData">Back</button>
          <button class="btn btn-sm btn-success" (click)="moveNext()"
            [disabled]="!informationConfirmed || loadingData">Next</button>
        </footer>
      </mat-step>

      <!-- STEP 3 -->
      <mat-step completed="false" editable="false" *ngIf="!loadingCheckForPurchaseActivation">
        <div class="stepcontainer">
          <ng-container *ngIf="!loadingData && !purchaseSuccess">
            <h2>Confirmation</h2>
            <p>You will have to pay the XRP equivalent of <b>~ {{getPurchaseAmountUSD()}} USD</b> to buy your vanity
              address <b>{{selectedVanityAddress && selectedVanityAddress.address}}</b></p>
            <div class="alert alert-danger">
              Funds can not be returned. After successfully purchase and account activation, the account is yours and
              YOURS only! The account can not be returned to us!
            </div>

          </ng-container>

          <div *ngIf="!loadingData && purchaseStarted && !purchaseSuccess" class="alert alert-danger">
            Your payment was not successfull on the XRP Ledger MAIN net.
          </div>

          <ng-container *ngIf="!loadingData && purchaseStarted && purchaseSuccess">
            <h2 class="text-center">Congratulations!</h2>
            <div class="alert alert-success">
              <p class="text-center">
                <i class="material-icons xumm-green" style="font-size: 2em;">
                  check_circle_outline
                </i>
              </p>
              <p class="text-center">
                You bought the address
              </p>
            </div>
            <code class="address">{{selectedVanityAddress && selectedVanityAddress.address}}</code>
          </ng-container>

        </div>

        <footer class="nextback">
          <button class="btn btn-sm btn-primarylight" (click)="moveBack();" [disabled]="loadingData">Back</button>
          <button *ngIf="purchaseSuccess" class="btn btn-sm btn-success" (click)="moveNext()"
            [disabled]="!purchaseSuccess || loadingData">Next</button>
          <button *ngIf="!purchaseSuccess" class="btn btn-sm btn-success" (click)="buyVanityAddress()"
            [disabled]="loadingData">Buy</button>
        </footer>

      </mat-step>

      <!-- STEP 4 -->
      <mat-step completed="false" editable="false" *ngIf="!loadingCheckForPurchaseActivation">
        <div class="stepcontainer">
          <div class="alert alert-warning" *ngIf="!accountActivated || !accountRekeyed || !!accountMasterKeyDisabled">
            In order to use your new address, it has to hold at least <b>10 XRP</b>. This is a requirement by the XRP
            Ledger. After you have activated your new account, we will change the porperties of that account that only
            YOU will have access to it!
          </div>

          <div *ngIf="!accountActivated && !loadingData" style="width: 100%;">
            <button class="btn btn-lg btn-success" style="width: 100%;" (click)="activateVanityAddress()"
              [disabled]="loadingData">Activate Vanity Address</button>
          </div>

          <mat-card *ngIf="accountActivated" class="mat-card-green" fxLayout="row" fxLayoutGap="0.3em"
            fxLayoutAlign="start center">
            <i class="material-icons xumm-green" style="font-size: 2em;">
              check_circle_outline
            </i>
            <label>The account <b>{{selectedVanityAddress && selectedVanityAddress.address}}</b> has been
              activated.</label>
          </mat-card>

          <mat-card *ngIf="accountActivated && accountRekeyed" class="mat-card-green" fxLayout="row" fxLayoutGap="0.3em"
            fxLayoutAlign="start center">
            <i class="material-icons xumm-green" style="font-size: 2em;">
              check_circle_outline
            </i>
            <label>Your account <b>{{originalAccountInfo.Account}}</b> can now sign transactions for
              <b>{{selectedVanityAddress && selectedVanityAddress.address}}</b>. That means YOU have access to the
              account now.</label>
          </mat-card>

          <mat-card *ngIf="accountActivated && accountRekeyed && accountMasterKeyDisabled" class="mat-card-green"
            fxLayout="row" fxLayoutGap="0.3em" fxLayoutAlign="start center">
            <i class="material-icons xumm-green" style="font-size: 2em;">
              check_circle_outline
            </i>
            <label>The master key for the vanity account <b>{{selectedVanityAddress &&
                selectedVanityAddress.address}}</b> is disabled. That means <b>WE</b> can not access this account
              anymore.<br><br><b>It is truly yours now, enjoy!</b></label>
          </mat-card>

          <div *ngIf="loadingData" fxLayout="column" fxLayoutAlign="center center">
            <label *ngIf="!accountActivated">Waiting for account activation...</label>
            <label *ngIf="accountActivated && !accountRekeyed">Waiting for account transfer...</label>
            <label *ngIf="accountActivated && accountRekeyed && !accountMasterKeyDisabled">Waiting for master key to
              be disabled...</label>

            <div class="spinner-border" role="status" style="padding-top: 0.5em;"></div>
          </div>

          <mat-card *ngIf="accountActivated && accountRekeyed && accountMasterKeyDisabled" class="mat-card-orange">
            <mat-card class="mat-card-red" *ngIf="rekeyAccount != originalAccountInfo.Account" fxLayout="column">
              <label>You have send the activation payment with a different account than the one you used for the
                payment and sign in earlier.</label>
              <label>We have now set <b>{{rekeyAccount}}</b> as "RegularKey". This account will now be able to sign
                transactions for <b>{{selectedVanityAddress && selectedVanityAddress.address}}</b></label>
            </mat-card>
            <label>To use your account, copy the following address (via the button) and add it as "Read only"
              account
              to your XUMM app:</label>
            <div fxLayout="row" fxLayoutGap="0.2em" fxLayoutAlign="start center" *ngIf="selectedVanityAddress">
              <label style="font-size: 0.9em;"
                (click)="copyAddress(selectedVanityAddress.address)"><b>{{selectedVanityAddress
                  &&
                  selectedVanityAddress.address}}</b></label>
              <button class="btn btn-sm" aria-label="Copy Address" (click)="copyAddress(selectedVanityAddress.address)">
                <mat-icon style="font-size: 16px; width: fit-content; height: fit-content;">content_copy</mat-icon>
              </button>
            </div>
          </mat-card>

          <div *ngIf="!loadingData && errorActivation">
            <mat-card class="mat-card-red" fxLayoutGap="0.3em">
              <label>There was an error activating your new vanity address.</label>
              <label>Please contact @nixerFFM or @WietseWind on twitter or send a mail to xyz@gmail.com</label>
            </mat-card>
          </div>

        </div>

      </mat-step>

    </mat-stepper>

  </div>
</div>

<div *ngIf="!openSearch">
  <mat-card>

    <div *ngIf="!loadingPurchases && (!purchasedAddresses || purchasedAddresses.length <=0 )" fxLayout="column">
      <mat-card class="mat-card-orange">
        <label>No purchases found.</label>
      </mat-card>
    </div>
    <div class="purchases" *ngIf="!loadingPurchases && purchasedAddresses && purchasedAddresses.length > 0"
      fxLayout="column">
      <ul class="list">
        <li *ngFor="let address of purchasedAddresses">
          <div>
            <code><b>{{address.vanityAddress}}</b></code>
          </div>

          <div fxLayout="row">
            <div style="width: 50%;">
              <b>Network:</b>&nbsp;
            </div>
            <div style="width: 50%;">
              <label>{{address.testnet ? 'Testnet' : 'Mainnet'}}</label>
            </div>
          </div>

          <div fxLayout="row">
            <div style="width: 50%;">
              <b>Activated:</b>&nbsp;
            </div>
            <div *ngIf="address.activated" style="width: 50%;">
              <i class="material-icons xumm-green">
                check_circle_outline
              </i>
            </div>

            <div *ngIf="!address.activated" style="width: 50%;">
              <i class="material-icons xumm-red" style="font-size: 1.4em;">
                highlight_off
              </i>
            </div>
          </div>

          <div fxLayout="row">
            <div style="width: 50%;">
              <b>Rekeyed:</b>&nbsp;
            </div>
            <div *ngIf="address.rekeyed" style="width: 50%;">
              <i class="material-icons xumm-green">
                check_circle_outline
              </i>
            </div>

            <div *ngIf="!address.rekeyed" style="width: 50%;">
              <i class="material-icons xumm-red" style="font-size: 1.4em;">
                highlight_off
              </i>
            </div>
          </div>

          <div fxLayout="row">
            <div style="width: 50%;">
              <b>Masterkey Disabled:</b>&nbsp;
            </div>
            <div *ngIf="address.masterDisabled" style="width: 50%;">
              <i class="material-icons xumm-green">
                check_circle_outline
              </i>
            </div>

            <div *ngIf="!address.masterDisabled" style="width: 50%;">
              <i class="material-icons xumm-red" style="font-size: 1.4em;">
                highlight_off
              </i>
            </div>
          </div>

          <div fxLayout="column">
            <div *ngIf="address.regularKey" fxLayout="column">
              <b>RegularKey:</b>
              <label style="font-size: 0.9em;">{{address.regularKey}}</label>
            </div>
            <div *ngIf="!address.regularKey" fxLayout="row">
              <div style="width: 50%;">
                <b>RegularKey:</b>
              </div>

              <div style="width: 50%;">
                <i class="material-icons xumm-red" style="font-size: 1.4em;">
                  highlight_off
                </i>
              </div>
            </div>

          </div>

          <div *ngIf="!address.activated" fxLayout="row">
            <div style="width: 50%;">
              <b>Actions:</b>
            </div>
            <div *ngIf="address.testnet == testMode" style="width: 50%;">
              <button class="btn btn-sm btn-success" (click)="selectPurchasedAddressAndActivate(address)"
                [disabled]="loadingData">Activate now</button>
            </div>
            <div *ngIf="address.testnet != testMode" style="width: 50%;">
              <label class="xumm-red">Please change the network of your XUMM app to activate this address.</label>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </mat-card>
</div>