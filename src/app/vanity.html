<div id="topbar" *ngIf="!stepper" >
  <mat-toolbar color="secondary" fxLayout="row">
    <div fxLayoutAlign="start start" style="width: 50%;">
      <button class="topbar-button-left btn" (click)="openSearchClick()" [ngClass]="{'active' : openSearch}"
        matTooltip="Buy Address">
        <i class="material-icons topbar-menu-icon">search</i>
        <label>&nbsp;Buy Address</label>
      </button>
    </div>
    <div fxLayoutAlign="end end" style="width: 50%;">
      <button class="topbar-button-right btn" (click)="openPurchaseClick()" matTooltip="Show Purchases" 
        [ngClass]="{'active' : !openSearch}">
        <i class="material-icons topbar-menu-icon">list</i>
        <label>&nbsp;Show Purchases</label>
      </button>
    </div>
  </mat-toolbar>
</div>

<mat-card class="mat-card-red" *ngIf="errorLabel">
  <label>Sorry that this error happened! Please copy the following error and send it to @XummSupport on twitter or
    visit https://support.xumm.app . Thank you for your help!</label>
  <label>&nbsp;</label>
  <label class="break-words" (click)="copyError()">{{errorLabel}}</label>
  <button mat-button class="xumm-grey-background" aria-label="Copy Error" (click)="copyError()">
    Copy&nbsp;<mat-icon style="font-size: 16px; width: fit-content; height: fit-content;">content_copy</mat-icon>
  </button>
</mat-card>

<!--label class="break-words" *ngIf="infoLabel" style="color: red">{{infoLabel}}</label><br><br>
  <label class="break-words" *ngIf="infoLabel2" style="color: red">{{infoLabel2}}</label>
  <label class="break-words" *ngIf="infoLabel3" style="color: red">{{infoLabel3}}</label-->

<div *ngIf="openSearch">

  <div
    *ngIf="loadingCheckForPurchaseActivation || loadingData || loadingPurchases || !originalAccountInfo"
    class="loader">
    <div class="spinner-border" role="status"></div>
    <label>Loading</label>
    <!-- <label *ngIf="!loadingData">Loading</label>
      <label *ngIf="loadingData">Searching addresses</label> -->
  </div>

  <div>
    <div *ngIf="!selectedVanityAddress && !loadingData">
      <div class="p-3 pb-1">
        <h1 class="sticky mb-0">
          <label>Find yourself a vanity XRPL address </label>
          <label><small>${{getPurchaseAmountUSD()}} / ~{{xrpAmountFirst}} XRP</small></label>
        </h1>
      </div>
      <div class="sticky p-3 pt-1 pb-1">
        <form>
          <div class="input-group mb-2 no-wrap-at-all">
            <span class="input-group-text"><i class="bi-search"></i></span>
            <input #inpvanityword class="form-control form-control-lg" minlength="3" maxlength="8" name="vanity word"
              placeholder="Look for your name / brand" [(ngModel)]="vanityWordInput"
              (ngModelChange)="checkVanitySearchChange()">
          </div>
          <button class="btn btn-lg btn-primarylight search" (click)="searchVanityAddress()"
            [disabled]="loadingData || !vanityWordInput || vanityWordInput.trim().length < 3 || !vanityWordValid">Search</button>
          <mat-hint *ngIf="vanityWordInput && vanityWordInput.length > 0 && !vanityWordValid" style="color: #ff5b5b">Invalid characters detected. Please check your input</mat-hint>
          <ul class="notes">
            <li>Always starts with r</li>
            <li>Min. 3 and Max. 8 characters</li>
            <li>Allowed: a-Z</li>
          </ul>
        </form>
      </div>

      <div *ngIf="searchResult && !selectedVanityAddress">

        <div *ngIf="searchResult.length > 0">
          <div class="listarea p-3 pt-4 pb-2">
            <h3>Adresses found ({{searchResult.length}}) :</h3>
            <ul class="list">
              <li *ngFor="let address of searchResult">
                <code>r<b>{{address.address.substring(1,vanityWordInput.length+1)}}</b>{{address.address.substring(vanityWordInput.length+1)}}</code>
                <div>
                  <button class="btn btn-sm btn-success" (click)="selectVanityAddress(address);">Buy</button>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <div *ngIf="searchResult.length <= 0">
          <div class="alert alert-warning m-3 p-2 text-center">
            <p>No vanity addresses found for your search. Please try a different word!</p>
            <b>Try changing your search word slightly!</b>
          </div>
        </div>
      </div>
    </div>

    <mat-stepper orientation="horizontal" [linear]="isLinear" #vanityStepper *ngIf="selectedVanityAddress">

      <!-- STEP 1 -->
      <mat-step completed="false" editable="false">
        <ng-container>
          <div class="stepcontainer">
            <ng-container *ngIf="originalAccountInfo">
              <h2>Payment account</h2>
              <ng-container *ngIf="originalAccountInfo && (originalAccountInfo.Account || originalAccountInfo.account)">
                <label>Selected account:</label>
                <code class="address"
                  *ngIf="originalAccountInfo && originalAccountInfo.Account"><b>{{originalAccountInfo.Account}}</b></code>
                <!-- TODO: we need this? -->
                <code class="address"
                  *ngIf="originalAccountInfo && originalAccountInfo.account">{{originalAccountInfo.account}}</code>
              </ng-container>

              <button class="btn btn-sm btn-primarylight changeaccount" (click)="signIn()"
                [disabled]="loadingData">{{originalAccountInfo && (originalAccountInfo.Account ||
                originalAccountInfo.account) ? 'Change account' : 'Sign In' }}</button>
              <hr>
              <div class="alert alert-warning">
                <p>Please choose the account which will be able to sign transactions for your new vanity address.</p>
                This account also needs to be used to activate the vanity address with <b>10 XRP</b> and pay for
                your vanity address (<b>100 USD in XRP</b>)
              </div>

            </ng-container>


            <mat-card
              *ngIf="originalAccountInfo && originalAccountInfo.error && originalAccountInfo.error == 'actNotFound' && !loadingData"
              class="mat-card-red">
              <label>Account not activated on {{testMode ? 'Testnet' : 'Mainnet'}}.</label>
            </mat-card>

            <mat-card *ngIf="originalAccountInfo && balanceTooLow && !loadingData" class="mat-card-red">
              <label>The balance of this account is too low!</label>
              <label>You should have at least {{(amountXrpNeeded/1000000)}} XRP in your account!</label>
            </mat-card>
          </div>

          <footer class="nextback">
            <button class="btn btn-sm btn-primarylight" (click)="selectedVanityAddress = null;"
              [disabled]="!originalAccountInfo || loadingData">
              Back
            </button>

            <button class="btn btn-sm btn-success" (click)="moveNext(true)"
              [disabled]="!originalAccountInfo || !originalAccountInfo.Account || loadingData">Next</button>
          </footer>
        </ng-container>
      </mat-step>

      <!-- STEP 2 -->
      <mat-step completed="false" editable="false">
        <div class="stepcontainer">
          <h2>Checks</h2>
          <p>Please read the information below carefully and sign the request to accept.</p>
          <!-- <div class="alert alert-warning">Please read the information below carefully and sign the request to accept.
          </div> -->

          <mat-checkbox [(ngModel)]="checkBoxPurchaseAmount" (change)="informationConfirmed = false;"
            [ngClass]="(checkBoxPurchaseAmount ? 'active': '')">You aggree to pay the XRP equivalent of <b>~
              {{getPurchaseAmountUSD()}} USD</b> to buy your vanity address <b>{{selectedVanityAddress &&
              selectedVanityAddress.address}}</b>
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="checkBoxActivation" (change)="informationConfirmed = false;"
            [ngClass]="(checkBoxActivation ? 'active': '')">You need to fund your new vanity address with the <b>10
              XRP</b> reserve fee of the XRP Ledger.</mat-checkbox>
          <mat-checkbox [(ngModel)]="checkBoxVanityAccReadOnly" (change)="informationConfirmed = false;"
            [ngClass]="(checkBoxVanityAccReadOnly ? 'active': '')">Vanity account <b>{{selectedVanityAddress &&
              selectedVanityAddress.address}}</b> needs to be imported as "Read only" in the XUMM app!
          </mat-checkbox>

          <div *ngIf="!informationConfirmed" class="alert alert-info">
            Please sign to confirm
          </div>

        </div>
        <footer class="nextback">
          <button class="btn btn-sm btn-primarylight" (click)="moveBack();" [disabled]="loadingData">Back</button>
          <button class="btn btn-sm btn-success" (click)="moveNext()"
            *ngIf="informationConfirmed" [disabled]="loadingData">Next</button>
          <button class="btn btn-lg btn-secondary signbutton" (click)="signToConfirm()"
            *ngIf="!checkBoxPurchaseAmount || !checkBoxActivation || !checkBoxVanityAccReadOnly || !informationConfirmed"
            [disabled]="loadingData || !checkBoxPurchaseAmount || !checkBoxActivation || !checkBoxVanityAccReadOnly || informationConfirmed">
            Sign</button>
        </footer>
      </mat-step>

      <!-- STEP 3 -->
      <mat-step completed="false" editable="false">
        <div class="stepcontainer">
          <ng-container *ngIf="!purchaseSuccess">
            <h2>Confirm</h2>
            <p>You will have to pay the XRP equivalent of <b>~ {{getPurchaseAmountUSD()}} USD</b> to buy your vanity
              address</p>
            <code class="address">{{selectedVanityAddress && selectedVanityAddress.address}}</code>
            <hr>
            <div class="alert alert-danger">
              Funds can not be returned. After successful purchase and account activation, the account is yours and
              YOURS only! The account can not be returned to us!
            </div>

          </ng-container>

          <div *ngIf="!loadingData && purchaseStarted && !purchaseSuccess" class="alert alert-danger">
            Your payment was not successful on the XRP Ledger MAIN net.
          </div>

          <ng-container *ngIf="!loadingData && purchaseStarted && purchaseSuccess">

            <div class="alert alert-success">
              <br>
              <p class="text-center">
                <i class="material-icons xumm-green" style="font-size: 3em;">
                  check_circle_outline
                </i>
              </p>
              <h2 class="text-center">Congratulations!</h2>
              <p class="text-center">
                You bought the address
              </p>
            </div>
            <code class="address">{{selectedVanityAddress && selectedVanityAddress.address}}</code>
          </ng-container>

        </div>

        <footer class="nextback">
          <button class="btn btn-sm btn-primarylight" (click)="moveBack();" [disabled]="loadingData">Back</button>
          <button *ngIf="purchaseSuccess" class="btn btn-sm btn-success" (click)="moveNext()"
            [disabled]="!purchaseSuccess || loadingData">Next</button>
          <button *ngIf="!purchaseSuccess" class="btn btn-sm btn-success" (click)="buyVanityAddress()"
            [disabled]="loadingData">Buy</button>
        </footer>

      </mat-step>

      <!-- STEP 4 -->
      <mat-step completed="false" editable="false">
        <div class="stepcontainer">
          <h2>Account ownership</h2>
          <p *ngIf="!accountActivated || !accountRekeyed || !!accountMasterKeyDisabled">
            In order to use your new address, it has to hold at least <b>10 XRP</b>. This is a requirement by the XRP
            Ledger. After you have activated your new account, we will change the porperties of that account that only
            YOU will have access to it!
          </p>

          <h3>1. Account activated</h3>
          <div *ngIf="accountActivated else accountActivatedMsg">
            <div class="alert alert-success">
              <i class="material-icons xumm-green" style="font-size: 1.5em; vertical-align: middle;">
                check_circle
              </i> This account has been activated.
            </div>
            <code class="address">{{selectedVanityAddress && selectedVanityAddress.address}}</code>
          </div>
          <ng-template #accountActivatedMsg>
            <button *ngIf="!accountActivated && !loadingData" class="btn btn-lg btn-success w-100 pt-2 pb-2"
              (click)="activateVanityAddress()" [disabled]="loadingData">Activate vanity address</button>
          </ng-template>

          <hr>

          <h3>2. Account access</h3>
          <div *ngIf="accountActivated && accountRekeyed else accountAccess">
            <div class="alert alert-success">
              <i class="material-icons xumm-green" style="font-size: 1.5em; vertical-align: middle;">
                check_circle
              </i>
              Your account <small>({{originalAccountInfo.Account}})</small> can now sign transactions for
            </div>
            <code class="address">{{selectedVanityAddress && selectedVanityAddress.address}}</code>
            <p>
              That means YOU have access to the account now.
            </p>
          </div>
          <ng-template #accountAccess>
            <div class="alert alert-info">
              Waiting for activation...
            </div>
          </ng-template>

          <hr>

          <h3>3. Disabling master key</h3>
          <div *ngIf="accountActivated && accountRekeyed && accountMasterKeyDisabled else accountMasterKeyDisabled">
            <div class="alert alert-success">
              <i class="material-icons xumm-green" style="font-size: 1.5em; vertical-align: middle;">
                check_circle
              </i>
              The master key for the vanity account is disabled.
            </div>
            <code class="address">{{selectedVanityAddress && selectedVanityAddress.address}}</code>
            <p>
              That means <b>WE</b> can not access this account anymore. <b>It is fully yours now, enjoy!</b>
            </p>
          </div>
          <ng-template #accountMasterKeyDisabled>
            <div class="alert alert-info">
              Waiting for account access...
            </div>
          </ng-template>

          <!-- <div *ngIf="loadingData" class="inlineloader">
            <label *ngIf="!accountActivated">Waiting for account activation...</label>
            <label *ngIf="accountActivated && !accountRekeyed">Waiting for account transfer...</label>
            <label *ngIf="accountActivated && accountRekeyed && !accountMasterKeyDisabled">Waiting for master key to
              be disabled...</label>

            <div class="spinner-border" role="status" style="padding-top: 0.5em;"></div>
          </div> -->


          <div *ngIf="accountActivated && accountRekeyed && accountMasterKeyDisabled" fxLayoutGap="0.3em">
            <div *ngIf="rekeyAccount != originalAccountInfo.Account" class="alert alert-danger">
              <label>You have sent the activation payment with a different account than the one you used for the
                payment and 'Sign in' earlier.</label>
              <label>We have now set <b>{{rekeyAccount}}</b> as "RegularKey". ONLY this account will be able to sign
                transactions for <b>{{selectedVanityAddress && selectedVanityAddress.address}}</b></label>
            </div>
            <div class="alert alert-warning" fxLayoutGap="0.3em">
              <label>To use your account, copy the following address (via the button) and add it as "Read only"
                account to your XUMM app:</label>
              <div *ngIf="selectedVanityAddress" fxLayoutGap="0.3em">
                <label (click)="copyAddress(selectedVanityAddress.address)"><b>{{selectedVanityAddress && selectedVanityAddress.address}}</b></label>
                <button class="btn btn-success btn-sm" aria-label="Copy Address"
                  (click)="copyAddress(selectedVanityAddress.address)">
                  <i class="material-icons" style="font-size: 16px; width: fit-content; height: fit-content;">
                    content_copy</i>
                </button>
              </div>
              <div class="listarea">
                <ul class="notes">
                  <li>Copy the above address via the above button</li>
                  <li>Close the xApp (DON'T DO IT NOW!)</li>
                  <li>Open "Settings" screen in you XUMM app</li>
                  <li>Select "Accounts"</li>
                  <li>Select "Add account"</li>
                  <li>Select "Import existing account"</li>
                  <li>Choose "Read only"</li>
                  <li>Paste your new vanity address</li>
                  <li>Follow the step to add an account until the end</li>
                  <li>You can now close this xApp</li>
                </ul>
              </div>
            </div>
          </div>

          <div *ngIf="!loadingData && errorActivation">
            <div class="alert alert-danger">
              <label>There was an error activating your new vanity address.</label>
              <label>Please contact @nixerFFM or @WietseWind on twitter or send a mail to xyz@gmail.com</label>
            </div>
          </div>

        </div>

        <!-- <footer class="nextback fullwidth">
          <button *ngIf="!accountActivated && !loadingData" class="btn btn-sm btn-success"
            (click)="activateVanityAddress()" [disabled]="loadingData">Activate Vanity Address</button>
        </footer> -->

      </mat-step>

    </mat-stepper>

  </div>
</div>

<div *ngIf="!openSearch">

  <div *ngIf="!loadingPurchases && (!purchasedAddresses || purchasedAddresses.length <=0 )" style="padding: 0.25rem">
    <label>No purchases found.</label>
  </div>
  <div class="purchases" *ngIf="!loadingPurchases && purchasedAddresses && purchasedAddresses.length > 0">
    <ul class="accountlist">
      <li *ngFor="let address of purchasedAddresses">

        <code class="address">{{address.vanityAddress}}</code>


        <div class="subgrid">
          <div>
            <b>Network:</b>
          </div>
          <div>
            {{address.testnet ? 'Testnet' : 'Mainnet'}}
          </div>
        </div>

        <div class="subgrid">
          <div>
            <b>Activated:</b>
          </div>
          <div *ngIf="address.activated">
            <i class="material-icons xumm-green">check_circle_outline</i>
          </div>
          <div *ngIf="!address.activated">
            <i class="material-icons xumm-red" style="font-size: 1.4em;">highlight_off</i>
          </div>
        </div>

        <div class="subgrid">
          <div>
            <b>Rekeyed:</b>&nbsp;
          </div>
          <div *ngIf="address.rekeyed">
            <i class="material-icons xumm-green">
              check_circle_outline
            </i>
          </div>

          <div *ngIf="!address.rekeyed">
            <i class="material-icons xumm-red" style="font-size: 1.4em;">
              highlight_off
            </i>
          </div>
        </div>

        <div class="subgrid">
          <div>
            <b>Masterkey disabled:</b>&nbsp;
          </div>
          <div *ngIf="address.masterDisabled">
            <i class="material-icons xumm-green">
              check_circle_outline
            </i>
          </div>

          <div *ngIf="!address.masterDisabled">
            <i class="material-icons xumm-red" style="font-size: 1.4em;">
              highlight_off
            </i>
          </div>
        </div>

        <div>
          <div *ngIf="address.regularKey" class="subgrid">
            <div><b>RegularKey:</b></div>
            <div>
              <label style="font-size: 0.9em;">{{address.regularKey}}</label>
            </div>
          </div>

          <div *ngIf="!address.regularKey" class="subgrid">
            <div>
              <b>RegularKey:</b>
            </div>
            <div>
              <i class="material-icons xumm-red" style="font-size: 1.4em;">highlight_off</i>
            </div>
          </div>

        </div>

        <div *ngIf="!address.activated" class="subgrid">
          <div>
            <b>Actions:</b>
          </div>
          <div *ngIf="address.testnet == testMode">
            <button class="btn btn-sm btn-success" (click)="selectPurchasedAddressAndActivate(address)"
              [disabled]="loadingData">Activate now</button>
          </div>
          <div *ngIf="address.testnet != testMode">
            <label class="xumm-red">Please change the network of your XUMM app to activate this address.</label>
          </div>
        </div>

      </li>
    </ul>
  </div>
</div>